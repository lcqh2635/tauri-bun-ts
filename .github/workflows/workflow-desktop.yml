# ä»¥ä¸‹å†…å®¹å‚è€ƒè‡ª https://github.com/tauri-apps/tauri-action?tab=readme-ov-file#usage

# å·¥ä½œæµåç§°ï¼šåœ¨ GitHub Actions ä¸­æ˜¾ç¤ºä¸º "publish"
# è¯´æ˜ï¼šè¿™æ˜¯è¯¥ CI/CD å·¥ä½œæµçš„åç§°ï¼Œä¼šåœ¨ GitHub çš„ Actions æ ‡ç­¾é¡µä¸­æ˜¾ç¤ºã€‚
name: workflow-desktop.yml

# è§¦å‘æ¡ä»¶ï¼šå½“å‘åä¸º 'release' çš„åˆ†æ”¯æ¨é€ä»£ç æ—¶è§¦å‘æ­¤å·¥ä½œæµ
# æ­¤å·¥ä½œæµä¸ä¼šåœ¨ main æˆ–å…¶ä»–åˆ†æ”¯è§¦å‘ã€‚åªæœ‰å½“ä½ å°†ä»£ç æ¨é€åˆ° release åˆ†æ”¯æ—¶ï¼Œæ‰ä¼šè‡ªåŠ¨æ‰§è¡Œæ„å»ºå’Œå‘å¸ƒã€‚æ¨èç”¨äºâ€œé¢„å‘å¸ƒâ€æˆ–â€œæ­£å¼å‘å¸ƒâ€æµç¨‹ï¼Œé¿å…é¢‘ç¹å‘å¸ƒã€‚
on:
  push:
    branches:
      - release

# è¿™æ˜¯å‘å¸ƒå¸¦ç­¾åè¯ä¹¦çš„é€šç”¨ macOS åº”ç”¨çš„ç¤ºä¾‹ã€‚
# æ¯æ¬¡æ¨é€åˆ° `release` åˆ†æ”¯æ—¶ï¼Œå®ƒä¼šåˆ›å»ºæˆ–æ›´æ–°ä¸€ä¸ª GitHub Releaseï¼Œ
# æ„å»ºä½ çš„åº”ç”¨ï¼Œå¹¶å°†æ„å»ºäº§ç‰©ï¼ˆartifactsï¼‰ä¸Šä¼ åˆ°è¯¥ Releaseã€‚
jobs:
  publish-tauri:
    # ç»™äºˆæ­¤ Job æ“ä½œä»“åº“å†…å®¹çš„å†™æƒé™ï¼ˆç”¨äºåˆ›å»º/æ›´æ–° GitHub Releaseï¼‰
    permissions:
      contents: write
    # æ„å»ºç­–ç•¥é…ç½®
    strategy:
      # å³ä½¿æŸä¸ªä»»åŠ¡å¤±è´¥ï¼Œä¹Ÿç»§ç»­è¿è¡Œå…¶ä»–ä»»åŠ¡ï¼ˆè¿™é‡Œåªæœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œä½œç”¨ä¸å¤§ï¼‰ã€‚
      fail-fast: false
      # æ‰‹åŠ¨å®šä¹‰æ„å»ºä»»åŠ¡çŸ©é˜µã€‚
      matrix:
        include:
            # ä½¿ç”¨æœ€æ–°çš„ macOS è™šæ‹Ÿæœºï¼ˆGitHub Hosted Runnerï¼‰ã€‚
          - platform: "macos-latest" # é€‚ç”¨äºåŸºäº Arm çš„ Macï¼ˆM1 åŠæ›´é«˜ç‰ˆæœ¬ï¼‰
            # å‘Šè¯‰ cargo tauri build æ„å»ºé€‚ç”¨äºåŸºäº Arm çš„ Macï¼ˆApple Siliconï¼ˆM1/M2ï¼‰åŠæ›´é«˜ç‰ˆæœ¬ï¼‰
            args: "--target aarch64-apple-darwin"
          - platform: "macos-latest" # é€‚ç”¨äºåŸºäº Intel çš„ Macã€‚
            args: "--target x86_64-apple-darwin"
          - platform: 'ubuntu-24.04'
            args: ''
          - platform: 'windows-latest'
            args: ''
    # æŒ‡å®šè¿è¡Œæ­¤ Job çš„è™šæ‹Ÿæœºç¯å¢ƒï¼ˆä» matrix ä¸­åŠ¨æ€è·å–ï¼‰
    runs-on: ${{ matrix.platform }}
    # æ„å»ºæ­¥éª¤åˆ—è¡¨
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç ä»“åº“ï¼ˆåŒ…æ‹¬å­æ¨¡å—ï¼‰
      # ä½¿ç”¨ GitHub å®˜æ–¹çš„ checkout åŠ¨ä½œï¼Œå°†ä»£ç æ‹‰å–åˆ° CI ç¯å¢ƒä¸­ã€‚
      # é»˜è®¤ä¼šé€’å½’æ£€å‡ºå­æ¨¡å—ï¼ˆTauri æœ‰æ—¶ä¾èµ– git å­æ¨¡å—ï¼‰ã€‚
      - uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šå®‰è£… Tauri åœ¨ Debian ç³»æ“ä½œç³»ç»Ÿä¸Šçš„ç³»ç»Ÿä¾èµ–
      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-24.04' # è¿™å¿…é¡»ä¸ä¸Šé¢å®šä¹‰çš„å¹³å°å€¼åŒ¹é…ã€‚
        run: |
          sudo apt update
          sudo apt install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev
        # webkitgtk 4.0 é€‚ç”¨äº Tauri v1 - webkitgtk 4.1 é€‚ç”¨äº Tauri v2ã€‚
        # æ‚¨å¯ä»¥åˆ é™¤ä¸é€‚ç”¨äºæ‚¨çš„åº”ç”¨ç¨‹åºçš„é‚£ä¸ªï¼Œä»¥ç¨å¾®åŠ å¿«å·¥ä½œæµç¨‹ã€‚

      # ç¬¬ä¸‰æ­¥ï¼šå®‰è£… Rust ç¨³å®šç‰ˆå·¥å…·é“¾
      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # ä¸º macOS å¹³å°å®‰è£…ä¸¤ä¸ªç›®æ ‡æ¶æ„çš„äº¤å‰ç¼–è¯‘æ”¯æŒ
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      # ç¬¬å››æ­¥ï¼šå®‰è£… Node.js ç¯å¢ƒï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ https://github.com/actions/setup-node
      - name: Install node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*     # å®‰è£…æœ€æ–°çš„ LTS ç‰ˆæœ¬ Node.js
          registry-url: 'https://registry.npmmirror.com'  # é…ç½® npm é•œåƒ

      # å®‰è£…å¹¶é…ç½® bun (å¦‚æœä½ ä½¿ç”¨ bun)ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ https://github.com/oven-sh/setup-bun
      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          registry-url: 'https://registry.npmmirror.com'

      # ç¬¬äº”æ­¥ï¼šå®‰è£…å‰ç«¯ä¾èµ–
      - name: install frontend dependencies
        run: bun install     # æ ¹æ®æ‚¨ä½¿ç”¨çš„é€‰é¡¹ï¼Œå°†å…¶æ›´æ”¹ä¸º npmã€yarnã€pnpm æˆ– bunã€‚

      # ç¬¬å…­æ­¥ï¼šä½¿ç”¨ Tauri Action æ„å»ºã€ç­¾åå¹¶å‘å¸ƒåº”ç”¨ã€‚å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://github.com/tauri-apps/tauri-action
      - name: build and publish
        uses: tauri-apps/tauri-action@v0
        env:
          # GitHub Tokenï¼ˆè‡ªåŠ¨æä¾›ï¼‰
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # å¦‚æœä½¿ç”¨äº† Tauri æ›´æ–°å™¨æ’ä»¶åˆ™å¿…é¡»è¦é…ç½®ï¼Œå‚è€ƒ Tauri æ–‡æ¡£ https://v2.tauri.org.cn/plugin/updater/
          # å°† bun tauri signer generate ç”Ÿæˆçš„ tauri-key.pub (å…¬é’¥)å’Œtauri-key.key (ç§é’¥) æ‰‹åŠ¨é…ç½®åˆ° Github ä¸Š
          # cat ~/.tauri/tauri-bun-vite.key.pub
          # éœ€è¦è‡ªå·±æ‰‹åŠ¨é…ç½®ï¼Œè¿›å…¥ GitHub ä»“åº“çš„ Settings â†’ Secrets and variables â†’ Actions å…·ä½“é“¾æ¥å¦‚ä¸‹ï¼š
          # https://github.com/lcqh2635/tauri-bun-ts/settings/secrets/actions
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          #  å‘å¸ƒçš„æ ‡ç­¾åï¼šæ ¼å¼ä¸º app-v1.0.0ï¼ˆè‡ªåŠ¨æ›¿æ¢ __VERSION__ ä¸º package.json ä¸­çš„ç‰ˆæœ¬ï¼‰
          tagName: v__VERSION__ # è¯¥ä½œä¼šè‡ªåŠ¨å°† \_\_VERSION\_\_ æ›¿æ¢ä¸ºåº”ç”¨ç¨‹åºç‰ˆæœ¬ã€‚
          # Release æ˜¾ç¤ºåç§°
          releaseName: "Tauri Bun TS v__VERSION__"
          # Release æè¿°å†…å®¹
          releaseBody: |
            # v0.1.0 - åˆå§‹å‘å¸ƒ
  
            ## ğŸš€ æ–°ç‰¹æ€§
            - **ç”¨æˆ·ç™»å½•**ï¼šæ”¯æŒç”¨æˆ·æ³¨å†Œå’Œç™»å½•åŠŸèƒ½
            - **ä»»åŠ¡ç®¡ç†**ï¼šæä¾›ç®€å•æ˜“ç”¨çš„ä»»åŠ¡ç®¡ç†ç•Œé¢
  
            ## ğŸ› ä¿®å¤é—®é¢˜
            - ä¿®å¤äº†é¦–æ¬¡å¯åŠ¨æ—¶çš„å´©æºƒé—®é¢˜
            - ä¼˜åŒ–äº†ä»»åŠ¡åˆ—è¡¨çš„åŠ è½½é€Ÿåº¦
  
            ## ğŸ¨ ç•Œé¢æ”¹è¿›
            - é‡æ–°è®¾è®¡äº†ä¸»ç•Œé¢å¸ƒå±€ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
            - æ·»åŠ äº†å¤œé—´æ¨¡å¼æ”¯æŒ
  
            ## ğŸ‘©â€ğŸ’» å¼€å‘è€…å·¥å…·
            - ä½¿ç”¨ Tauri æ„å»ºè·¨å¹³å°åº”ç”¨
            - ä½¿ç”¨ Rust ä½œä¸ºåç«¯é€»è¾‘è¯­è¨€
  
            ## ğŸ“¦ ä¸‹è½½
            - [Windows ç‰ˆæœ¬](https://github.com/yourusername/yourrepo/releases/download/v0.1.0/YourApp-v0.1.0.exe)
            - [macOS ç‰ˆæœ¬](https://github.com/yourusername/yourrepo/releases/download/v0.1.0/YourApp-v0.1.0.dmg)
            - [Linux ç‰ˆæœ¬](https://github.com/yourusername/yourrepo/releases/download/v0.1.0/YourApp-v0.1.0.AppImage)

            ## ğŸ“¸ æˆªå›¾é¢„è§ˆ
            ![ä¸»ç•Œé¢](https://example.com/main-ui.png)
            ![ä»»åŠ¡ç®¡ç†](https://example.com/task-manager.png)
  
            ## ğŸ¤ è´¡çŒ®
            æ¬¢è¿æäº¤ Issue æˆ– Pull Requestï¼

          # æ˜¯å¦ä¸ºè‰ç¨¿ï¼ˆå»ºè®®è®¾ä¸º trueï¼Œäººå·¥ç¡®è®¤åå†å‘å¸ƒï¼‰
          releaseDraft: false
          # æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          prerelease: false
          # æ„å»ºå‚æ•°ï¼ˆä» matrix ä¸­ä¼ å…¥ï¼‰
          args: ${{ matrix.args }}
